<plugin id="Ex04SimpleAR" version="@DASH_VERSION@">

    <requirement id="dataReg" />
    <requirement id="arDataReg" />
    <requirement id="servicesReg" />
    <requirement id="visuVTKQt" />
    <requirement id="tracker" />
    <requirement id="trackerAruco" />
    <requirement id="arMedia" />

    <extension implements="::fwServices::registry::AppConfig2">
        <id>Ex04SimpleARConfig</id>
        <config>

            <object uid="cameraSeries" type="::arData::CameraSeries" />
            <object uid="camera" type="::arData::Camera" src="deferred" />

            <object uid="frameTL" type="::arData::FrameTL">
                <value>100</value>
            </object>
            <object uid="tagTL" type="::arData::MarkerTL" />
            <object uid="videoImage" type="::fwData::Image" />
            <object uid="matrixTL" type="::arData::MatrixTL" />
            <object uid="matrix" type="::fwData::TransformationMatrix3D" />
            <object uid="identity" type="::fwData::TransformationMatrix3D" />
            <object uid="inverseMat" type="::fwData::TransformationMatrix3D" />

            <service uid="mainFrame" type="::gui::frame::SDefaultFrame" >
                <gui>
                    <frame>
                        <name>Ex04SimpleAR</name>
                        <icon>@BUNDLE_PREFIX@/Ex04SimpleAR_0-1/app.ico</icon>
                    </frame>
                    <toolBar />
                </gui>
                <registry>
                    <toolBar sid="toolbar" start="yes" />
                    <view sid="cameraView" start="yes" />
                </registry>
            </service>

            <service uid="toolbar" type="::gui::aspect::SDefaultToolBar" >
                <gui>
                    <layout>
                        <menuItem name="Load Calibration" icon="@BUNDLE_PREFIX@/media_0-1/icons/Plus.svg"/>
                        <editor />
                        <menuItem name="start" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/start-cam.svg" />
                        <menuItem name="stop" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/stop-cam.svg" />
                        <menuItem name="pause" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/pause-cam.svg" />
                    </layout>
                </gui>
                <registry>
                    <menuItem sid="loadCalib" start="yes" />
                    <editor sid="CameraSelector" />
                    <menuItem sid="startVideo" start="yes" />
                    <menuItem sid="stopVideo" start="yes" />
                    <menuItem sid="pauseVideo" start="yes" />
                </registry>
            </service>

            <service uid="loadCalib" type="::gui::action::SSlotCaller" >
                <slots>
                    <slot>CalibrationReader/update</slot>
                </slots>
            </service>

            <service uid="startVideo" type="::gui::action::SSlotCaller" >
                <slots>
                    <slot>frameGrabber/startCamera</slot>
                </slots>
            </service>

            <service uid="stopVideo" type="::gui::action::SSlotCaller" >
                <slots>
                    <slot>frameGrabber/stopCamera</slot>
                </slots>
            </service>

            <service uid="pauseVideo" type="::gui::action::SSlotCaller" >
                <slots>
                    <slot>frameGrabber/pauseCamera</slot>
                </slots>
            </service>

            <service uid="CalibrationReader" type="::ioCalibration::SOpenCVReader">
                <inout key="target" uid="cameraSeries"/>
            </service>


           <service uid="Extractor" type="::ctrlCamp::SExtractObj" >
               <inout key="source" uid="cameraSeries">
                   <extract from="@cameras.0" />
               </inout>
               <out group="target">
                   <key uid="camera"/>
               </out>
         </service>

        <service uid="cameraView" type="::gui::view::SDefaultView" >
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="horizontal" />
                    <view proportion="1" />
                    <view proportion="0" />
                </layout>
            </gui>
            <registry>
                <view sid="genericScene" />
                <view sid="parameters" start="yes" />
            </registry>
        </service>

        <service uid="genericScene" type="::fwRenderVTK::SRender" autoConnect="yes">
            <in key="camera" uid="camera" />
            <in key="image" uid="videoImage" />
            <in key="transform" uid="inverseMat" />
            <in key="identity" uid="identity" />

            <scene>
                <renderer id="video" layer="0" background="0.0" />
                <renderer id="default" layer="1" background="0.0" />

                <adaptor id="videoAdapter" class="::visuVTKARAdaptor::SVideoAdapter" objectId="image">
                    <config renderer="video" cameraUID="camera"/>
                </adaptor>

                <adaptor id="interactorStyle" class="::visuVTKAdaptor::InteractorStyle" objectId="self">
                    <config renderer="default" style="InteractorStyle2DForNegato" />
                </adaptor>

                <adaptor id="registrationTransform" class="::visuVTKAdaptor::Transform" objectId="transform">
                    <config renderer="default" picker="" transform="registrationMatrix" />
                </adaptor>

                <adaptor id="axis" class="::visuVTKAdaptor::Axes" objectId="self">
                    <config renderer="default" transform="registrationMatrix" autoresetcamera="yes" length="50"/>
                </adaptor>

                <adaptor id="cameraAdaptor" class="::visuVTKARAdaptor::SCamera" objectId="identity">
                    <config renderer="default" cameraUID="camera"/>
                </adaptor>

            </scene>
        </service>

        <service uid="parameters" type="::guiQt::editor::SParameters" >
            <parameters>
                <param type="bool" name="Show Marker" key="debugMode" defaultValue="true" />
                <param type="enum" name="Detection Method" key="method" defaultValue="CANNY" values="ADPT_THRES,FIXED_THRES,CANNY" />
                <param type="enum" name="Corner ref." key="corner" defaultValue="SUBPIX" values="NONE,HARRIS,SUBPIX,LINES" />
                <param type="double" name="block size" key="blocksize" defaultValue="7." min="0." max="30." />
                <param type="double" name="constant" key="constant" defaultValue="7." min="0." max="50." />
                <param type="double" name="border width(%)" key="borderwidth" defaultValue="0.01" min="0." max="99.9" />
                <param type="int" name="Pattern Width(mm)" key="pattern" defaultValue="60" min="10" max="1000" />
                <param type="int" name="Speed" key="speed" defaultValue="3" min="1" max="3" />
            </parameters>
        </service>

        <service uid="tracker" type="::trackerAruco::SArucoTracker"  worker="tracking">
            <in key="timeline" uid="frameTL" autoConnect="yes"/>
            <in key="camera" uid="camera" />
            <inout group="tagTL" >
                <key uid="tagTL" />
            </inout>
            <config>
                <track>
                    <marker id="101" />
                </track>
                <threshold>
                    <method>ADPT_THRES</method>
                    <blockSize>7</blockSize>
                    <constant>7</constant>
                </threshold>
                <patternWidth>60</patternWidth>
                <debugMarkers>yes</debugMarkers>
            </config>
        </service>

        <service uid="synchronizer" type="::videoTools::SFrameMatrixSynchronizer"  worker="videoWorker">
            <in group="frameTL">
                <key uid="frameTL" />
            </in>
            <inout group="image">
                <key uid="videoImage" />
            </inout>
            <in group="matrixTL">
                <key uid="matrixTL" />
            </in>
            <inout group="matrices0">
                <key uid="matrix" />
            </inout>
            <framerate>30</framerate>
        </service>

        <service uid="registration" type="::tracker::SHomography" worker="registration">
            <in group="markerTL" autoConnect="yes">
                <key uid="tagTL" />
            </in>
            <in group="camera">
                <key uid="camera" />
            </in>
            <inout key="matrixTL" uid="matrixTL" />
            <patternWidth>60</patternWidth>
        </service>

        <service uid="CameraSelector" type="::videoQt::editor::SCamera" >
            <inout key="camera" uid="camera" />
            <videoSupport>yes</videoSupport>
        </service>

        <service uid="frameGrabber" type="::videoQt::SFrameGrabber" >
            <in key="camera" uid="camera" />
            <inout key="frameTL" uid="frameTL" />
        </service>

        <service uid="concatenate" type="::maths::SConcatenateMatrices" >
            <in group="matrix">
                <key uid="matrix" autoConnect="yes" inverse="false"/>
                <key uid="identity"/>
            </in>
            <inout key="output" uid="inverseMat" />
        </service>

        <connect>
            <signal>parameters/boolChanged</signal>
            <slot>tracker/setBoolParameter</slot>
        </connect>

        <connect>
            <signal>parameters/intChanged</signal>
            <slot>tracker/setIntParameter</slot>
        </connect>

        <connect>
            <signal>parameters/doubleChanged</signal>
            <slot>tracker/setDoubleParameter</slot>
        </connect>

        <connect>
            <signal>parameters/enumChanged</signal>
            <slot>tracker/setEnumParameter</slot>
        </connect>

        <connect>
            <signal>cameraSeries/addedCamera</signal>
            <slot>Extractor/update</slot>
        </connect>

        <connect>
            <signal>camera/idModified</signal>
            <slot>frameGrabber/stopCamera</slot>
        </connect>

        <start uid="mainFrame" />
        <start uid="frameGrabber" />
        <start uid="synchronizer" />
        <start uid="tracker" />
        <start uid="CalibrationReader"/>
        <start uid="CameraSelector" />
        <start uid="Extractor" />
        <start uid="registration" />
        <start uid="concatenate" />
        <start uid="genericScene" />

        </config>
    </extension>

</plugin>
