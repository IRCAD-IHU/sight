<extension implements="::fwServices::registry::AppConfig2">
    <id>curvedPlanarReformation</id>
    <parameters>
        <param name="WID_PARENT" />
        <param name="GENERIC_UID" />
        <param name="SERIESDB" />
        <param name="AS_UID" />
        <param name="ICON_PATH" />
        <param name="ModelSeriesCompositeUid" />
        <param name="imageUid" />
        <param name="SplinePointListUid" />
        <param name="orientation" default="axial" />
    </parameters>
    <config>

        <object uid="${AS_UID}" type="::fwMedData::ActivitySeries" src="ref" />
        <object uid="${SplinePointListUid}" type="::fwData::PointList" src="ref" />
        <object uid="${SERIESDB}" type="::fwMedData::SeriesDB" src="ref" />
        <object uid="${imageUid}" type="::fwData::Image" src="ref" />

        <object uid="selectedPoints" type="::fwData::PointList"/>
        <object uid="cprImagePoints" type="::fwData::PointList"/>
        <object uid="ImageCPRUid" type="::fwData::Image" />
        <object uid="CurrentViewPoint" type="::fwData::TransformationMatrix3D" />
        
        <service uid="mainView" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::CardinalLayoutManager">
                    <view caption="Negato" align="left" minWidth="350"/>
                    <view caption="Negato" align="right" minWidth="350"/>
                    <view caption="Negato" align="left" minWidth="350"/>
                    <view caption="CurvedPlanarReformation" align="right" minWidth="350" />
                </layout>
            </gui>
            <registry>
                <parent wid="${WID_PARENT}" />
                <view sid="view_negato1" start="yes"/>
                <view sid="view2" start="yes"/>
                <view sid="view_negato3" start="yes"/>
                <view sid="view4" start="yes"/>
            </registry>
        </service>

        <service uid="view2" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" />
                </layout>
            </gui>
            <registry>
                <view sid="view2Tab" start="yes" />
            </registry>
        </service>

        <service uid="view2Tab" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::TabLayoutManager">
                    <view caption="SplineEditor" />
                    <view caption="Negato" />
                    <view caption="3D Negato" />
                </layout>
            </gui>
            <registry>
                <view sid="SplineEditor" start="yes" />
                <view sid="view_negato2" start="yes" />
                <view wid="view_negato3D" />
            </registry>
        </service>


        <service uid="view_negato1" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" />
                    <view proportion="0" minHeight="30" />
                </layout>
            </gui>
            <registry>
                <view sid="negato1" start="yes" />
                <view sid="slider_negato1" start="yes" />
            </registry>
        </service>

        <service uid="view_negato2" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" />
                    <view proportion="0" minHeight="30" />
                </layout>
            </gui>
            <registry>
                <view sid="negato2" start="yes" />
                <view sid="slider_negato2" start="yes" />
            </registry>
        </service>

        <service uid="view_negato3" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" />
                    <view proportion="0" minHeight="30" />
                </layout>
            </gui>
            <registry>
                <view sid="negato3" start="yes" />
                <view sid="slider_negato3" start="yes" />
            </registry>
        </service>



        <service uid="SplineEditor" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" minHeight="50"/>
                </layout>
            </gui>
            <registry>
                <view sid="splinePointsEditor" start="no" />
            </registry>
        </service>

        <service uid="view4" type="::gui::view::SDefaultView" autoConnect="no">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" minHeight="100"/>
                    <view proportion="0" minHeight="30"/>
                </layout>
            </gui>
            <registry>
                <view sid="CurvedPlanarReformation2D" start="no" />
                <view sid="cprEditor" start="no" />
            </registry>
        </service>

        <service uid="cfgNegato3D" type="::fwServices::SConfigController">
        
            <appConfig id="cprViewDebug" />
            <inout key="imageUid" uid="${imageUid}" />
            <inout key="CurrentViewPointUid" uid="CurrentViewPoint" />
            <inout key="splinePointsListUid" uid="${SplinePointListUid}" />
            <inout key="selectedPointsUid" uid="selectedPoints" />
            
            <parameter replace="WID_PARENT" uid="view_negato3D" />
            <parameter replace="ICON_PATH" by="${ICON_PATH}" />
            <parameter replace="cprEditorUid" uid="cprEditor" />
        </service>

        <!-- GENERIC SCENE DEFINITION -->
        <!-- Negato1-->
        <service uid="negato1" type="::fwRenderVTK::SRender" autoConnect="yes">
            <in key="selectedPoints" uid="selectedPoints" />
            <in key="imageKey" uid="${imageUid}" />
            <scene>

                <picker id="negatodefault" vtkclass="fwVtkCellPicker" />

                <renderer id="default" background="0.0" />

                <adaptor id="interactor" class="::visuVTKAdaptor::InteractorStyle" objectId="self">
                    <config renderer="default" style="InteractorStyle2DForNegato" />
                </adaptor> 

                <adaptor id="MPRNegato" class="::visuVTKAdaptor::NegatoMPR" objectId="imageKey">
                    <config renderer="default" picker="negatodefault" mode="2d" slices="1" sliceIndex="axial" />
                </adaptor>

                <adaptor id="text" class="::visuVTKAdaptor::ImageText" objectId="imageKey">
                    <config renderer="default" picker="negatodefault" text="" />
                </adaptor>

                <adaptor id="PickerInteractor" uid="Picker1" class="::visuVTKAdaptor::PickerInteractor" objectId="self">
                    <config renderer="default" picker="negatodefault" />
                </adaptor>

                <adaptor id="PointList" class="::visuVTKAdaptor::LabeledPointList" objectId="selectedPoints">
                    <config renderer="default" picker="negatodefault" />
                </adaptor>
                
                <proxy channel="interaction_channel">
                    <signal>Picker1/picked</signal>
                </proxy>

            </scene>
        </service>

        <!-- Negato2 -->
        <service uid="negato2" type="::fwRenderVTK::SRender" autoConnect="yes">
            <in key="selectedPoints" uid="selectedPoints" />
            <in key="imageKey" uid="${imageUid}" />
            <scene>

                <picker id="negatodefault" vtkclass="fwVtkCellPicker" />

                <renderer id="default" background="0.0" />

                <adaptor id="interactor" class="::visuVTKAdaptor::InteractorStyle" objectId="self">
                    <config renderer="default" style="InteractorStyle2DForNegato" />
                </adaptor>

                <adaptor id="MPRNegato" class="::visuVTKAdaptor::NegatoMPR" objectId="imageKey">
                    <config renderer="default" picker="negatodefault" mode="2d" slices="1" sliceIndex="frontal" />
                </adaptor>

                <adaptor id="text" class="::visuVTKAdaptor::ImageText" objectId="imageKey">
                    <config renderer="default" picker="negatodefault" text="" />
                </adaptor>

                <adaptor id="multiDistances" class="::visuVTKAdaptor::ImageMultiDistances" objectId="imageKey">
                    <config filter="true" renderer="default" picker="negatodefault" />
                </adaptor>

                <adaptor id="Picker" uid="Picker2" class="::visuVTKAdaptor::PickerInteractor" objectId="self">
                    <config renderer="default" picker="negatodefault" />
                </adaptor>

                <adaptor id="PointList" class="::visuVTKAdaptor::LabeledPointList" objectId="selectedPoints">
                    <config renderer="default" picker="negatodefault" />
                </adaptor>
                
                <proxy channel="interaction_channel">
                    <signal>Picker2/picked</signal>
                </proxy>

            </scene>
        </service>

        <!-- Negato3 -->

        <service uid="negato3" type="::fwRenderVTK::SRender" autoConnect="yes">
            <in key="selectedPoints" uid="selectedPoints" />
            <in key="imageKey" uid="${imageUid}" />
            <scene>

                <picker id="negatodefault" vtkclass="fwVtkCellPicker" />

                <renderer id="default" background="0.0" />

                <adaptor id="interactor" class="::visuVTKAdaptor::InteractorStyle" objectId="self">
                    <config renderer="default" style="InteractorStyle2DForNegato" />
                </adaptor>

                <adaptor id="MPRNegato" class="::visuVTKAdaptor::NegatoMPR" objectId="imageKey">
                    <config renderer="default" picker="negatodefault" mode="2d" slices="1" sliceIndex="sagittal" /> 
                </adaptor>

                <adaptor id="text" class="::visuVTKAdaptor::ImageText" objectId="imageKey">
                    <config renderer="default" picker="negatodefault" text="" />
                </adaptor>

                <adaptor id="multiDistances" class="::visuVTKAdaptor::ImageMultiDistances" objectId="imageKey">
                    <config filter="true" renderer="default" picker="negatodefault" />
                </adaptor>

                <adaptor id="Picker" uid="Picker3" class="::visuVTKAdaptor::PickerInteractor" objectId="self">
                    <config renderer="default" picker="negatodefault" />
                </adaptor>

                <adaptor id="PointList" class="::visuVTKAdaptor::LabeledPointList" objectId="selectedPoints">
                    <config renderer="default" picker="negatodefault" />
                </adaptor>

                <proxy channel="interaction_channel">
                    <signal>Picker3/picked</signal>
                </proxy>
            </scene>
        </service>

        <service uid="CurvedPlanarReformation2D" type="::fwRenderVTK::SRender" autoConnect="yes">
            <in key="cprImagePoints" uid="cprImagePoints" />
            <in key="imageCPR" uid="ImageCPRUid" />
            <scene>

                <picker id="negatodefault" vtkclass="fwVtkCellPicker" />

                <renderer id="default" background="0.0" />

                <adaptor id="MPRNegato" class="::visuVTKAdaptor::NegatoMPR" objectId="imageCPR">
                    <config renderer="default" picker="negatodefault" mode="2d" slices="1" sliceIndex="axial"/>
                </adaptor>

                <adaptor id="PointList" class="::visuVTKAdaptor::LabeledPointList" objectId="cprImagePoints">
                    <config renderer="default" picker="negatodefault" />
                </adaptor>

            </scene>
        </service> 

        <service uid="cprEditor" type="::uiCPR::SCPREditor" autoConnect="yes">
            <in key="image" uid="${imageUid}"/>
        </service>


        <service uid="MedicalImageSrv2" type="::ctrlSelection::MedicalImageSrv" autoConnect="no" >
            <inout key="image" uid="${imageUid}"/>
        </service>
        <service uid="LockImageSrv" type="::ctrlMemory::LockDumpSrv" autoConnect="no" >
            <inout key="image" uid="${imageUid}"/>
        </service>

        <service uid="slider_negato1" type="::uiImageQt::SliceIndexPositionEditor" autoConnect="yes">
            <inout key="image" uid="${imageUid}"/>
            <sliceIndex>axial</sliceIndex>
        </service> 

        <service uid="slider_negato2" type="::uiImageQt::SliceIndexPositionEditor" autoConnect="yes">
            <inout key="image" uid="${imageUid}"/>
            <sliceIndex>frontal</sliceIndex>
        </service>

        <service uid="slider_negato3" type="::uiImageQt::SliceIndexPositionEditor" autoConnect="yes">
            <inout key="image" uid="${imageUid}"/>
            <sliceIndex>sagittal</sliceIndex>
        </service>      

        <service uid="SJumpToPoint" type="::ctrlSplineNavigation::SJumpToPointController" autoConnect="yes" worker="SJumpToPoint_worker" >
            <inout key="matrix" uid="CurrentViewPoint"/>
        </service>

        <service uid="splinePointsEditor" type="::uiSpline::SSplinePointsEditor" autoConnect="yes">
            <inout key="points" uid="${SplinePointListUid}"/>
            <inout key="selectedPoints" uid="selectedPoints"/>
        </service>
        <service uid="MoveAlongSpline" type="::ctrlSplineNavigation::SMoveAlongSpline" autoConnect="yes" >
            <in key="points" uid="${SplinePointListUid}"/>
        </service>

        <service uid="ComputeCPR2D" type="::ctrlComputeCPR::SComputeCPR2D" autoConnect="yes">
            <inout key="image" uid="ImageCPRUid" />
            <inout key="points" uid="cprImagePoints" />
            <in key="spline" uid="${SplinePointListUid}" />
            <in key="sourceImage" uid="${imageUid}" />
        </service>

        <connect>
            <signal>splinePointsEditor/pointSelected</signal>
            <slot>MoveAlongSpline/changeSelectedPoint</slot>
        </connect>

        <connect>
            <signal>MoveAlongSpline/PointChanged</signal>
            <slot>SJumpToPoint/changeDirectTarget</slot>
        </connect>

        <connect>
            <signal>${SplinePointListUid}/pointAdded</signal>
            <slot>ComputeCPR2D/addPoint</slot>
        </connect>

        <connect>
            <signal>${SplinePointListUid}/pointRemoved</signal>
            <slot>ComputeCPR2D/removePoint</slot>
        </connect>

        <connect>
            <signal>${SplinePointListUid}/modified</signal>
            <slot>ComputeCPR2D/updateSpline</slot>
        </connect>

        <connect>
            <signal>cprEditor/heightChanged</signal>
            <slot>ComputeCPR2D/changeHeight</slot>
        </connect>

        <connect>
            <signal>cprEditor/spacingChanged</signal>
            <slot>ComputeCPR2D/changeSpacing</slot>
        </connect>

        <connect>
            <signal>cprEditor/sliderProgressed</signal>
            <slot>ComputeCPR2D/changeAngle</slot>
        </connect>

        <connect>
            <signal>cprEditor/sliderProgressed</signal>
            <slot>MoveAlongSpline/changeAngle</slot>
        </connect>

        <connect>
            <signal>splinePointsEditor/indexPointSelected</signal>
            <slot>ComputeCPR2D/selectPoint</slot>
        </connect>
        
        <connect channel="interaction_channel">
            <slot>splinePointsEditor/getInteraction</slot>
        </connect>

        <!-- START AND STOP SERVICES -->
        <start uid="mainView" />
        <start uid="LockImageSrv" />
        <start uid="splinePointsEditor" />
        <start uid="SJumpToPoint" />
        <start uid="MoveAlongSpline"/>
        <start uid="ComputeCPR2D"/>
        <start uid="CurvedPlanarReformation2D"/>
        <start uid="cprEditor"/>
        <start uid="cfgNegato3D"/>

    </config>
</extension>

