<extension implements="::fwServices::registry::AppConfig2">
    <id>calibration</id>
    <parameters>
        <param name="WID_PARENT" />
        <param name="SERIESDB" />
        <param name="AS_UID" />
        <param name="cameraSeriesUid" />
        <param name="chessboardWidth" default="11" />
        <param name="chessboardHeight" default="8" />
        <param name="squareSizeChessboard" default="20" />
        <param name="videoGrabberImpl" default="::videoQt::SFrameGrabber" />
    </parameters>
    <config>

        <!-- ******************************* Objects declaration ****************************** -->

        <object uid="${SERIESDB}" type="::fwMedData::SeriesDB" src="ref" />
        <object uid="${AS_UID}" type="::fwMedData::ActivitySeries" src="ref" />

        <object uid="${cameraSeriesUid}" type="::arData::CameraSeries" src="ref" />

        <object uid="chessboardParameters" type="::fwData::Composite">
            <item key="chessboardWidth">
                <object type="::fwData::String">
                    <value>${chessboardWidth}</value>
                </object>
            </item>
            <item key="chessboardHeight">
                <object type="::fwData::String">
                    <value>${chessboardHeight}</value>
                </object>
            </item>
            <item key="squareSizeChessboard">
                <object type="::fwData::String">
                    <value>${squareSizeChessboard}</value>
                </object>
            </item>
        </object>

        <!-- ******************************* UI declaration *********************************** -->

        <service uid="mainView" type="::gui::view::SDefaultView" >
            <gui>
                <layout type="::fwGui::CardinalLayoutManager">
                    <view caption="Calibration" align="center" />
                </layout>
                <toolBar />
            </gui>
            <registry>
                <parent wid="${WID_PARENT}" />
                <view wid="calibrationView" />
                <toolBar sid="toolBar" start="yes" />
            </registry>
        </service>

        <service uid="toolBar" type="::gui::aspect::SDefaultToolBar" >
            <gui>
                <layout>
                    <menuItem name="Export camera series" icon="@BUNDLE_PREFIX@/media_0-1/icons/Export.svg" />
                    <menuItem name="Export activity" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/export_activity.svg" />
                    <separator />
                    <menuItem name="Export XML" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/save.svg" />
                    <separator />
                    <editor />
                    <separator />
                    <menuItem name="Chessboard size" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/chessboard.svg" />
                </layout>
            </gui>
            <registry>
                <menuItem sid="ActionExport" start="yes" />
                <menuItem sid="ActionExportActivity" start="yes" />
                <menuItem sid="ActionWriteXmlCalib" start="yes" />
                <editor sid="cameraLauncher" start="no" />
                <menuItem sid="action_chessBoardSize" start="yes" />
            </registry>
        </service>

        <!-- ******************************* Actions ****************************************** -->

        <service uid="ActionWriteXmlCalib" type="::gui::action::SSlotCaller" >
            <slots>
                <slot>CalibrationXmlWriter/update</slot>
            </slots>
        </service>

        <service uid="cameraLauncher" type="::uiCalibration::SCameraConfigLauncher" >
            <inout key="cameraSeries" uid="${cameraSeriesUid}" />
            <inout key="activitySeries" uid="${AS_UID}" />
            <config>
                <intrinsic>
                    <appConfig id="calIntrinsicView">
                        <parameters>
                            <parameter replace="WID_PARENT" uid="calibrationView" />
                            <parameter replace="chessboardWidth" by="${chessboardWidth}" />
                            <parameter replace="chessboardHeight" by="${chessboardHeight}" />
                            <parameter replace="squareSizeChessboard" by="${squareSizeChessboard}" />
                            <parameter replace="chessboardProxy" uid="chessboardProxy" />
                            <parameter replace="videoGrabberImpl" by="${videoGrabberImpl}" />
                        </parameters>
                    </appConfig>
                </intrinsic>
                <extrinsic>
                    <appConfig id="calExtrinsicView">
                        <parameters>
                            <parameter replace="WID_PARENT" uid="calibrationView" />
                            <parameter replace="chessboardWidth" by="${chessboardWidth}" />
                            <parameter replace="chessboardHeight" by="${chessboardHeight}" />
                            <parameter replace="squareSizeChessboard" by="${squareSizeChessboard}" />
                            <parameter replace="cameraSeriesUid" uid="${cameraSeriesUid}" />
                            <parameter replace="chessboardProxy" uid="chessboardProxy" />
                            <parameter replace="videoGrabberImpl" by="${videoGrabberImpl}" />
                        </parameters>
                    </appConfig>
                </extrinsic>
            </config>
        </service>

        <service uid="action_chessBoardSize" type="::videoCalibration::action::SCalibrationConfiguration" >
            <in key="parameters" uid="chessboardParameters" />
        </service>

        <service uid="ActionExport" type="::uiMedData::action::SExportSeries" autoConnect="yes">
            <inout key="seriesDB" uid="${SERIESDB}" />
            <inout key="series" uid="${cameraSeriesUid}" />
        </service>

        <service uid="ActionExportActivity" type="::uiMedData::action::SExportSeries" autoConnect="yes">
            <inout key="seriesDB" uid="${SERIESDB}" />
            <inout key="series" uid="${AS_UID}" />
        </service>

        <service uid="CalibrationXmlWriter" type="::uiIO::editor::SIOSelector" >
            <inout key="target" uid="${cameraSeriesUid}" />
            <type mode="writer" />
            <selection mode="include" />
            <addSelection service="::ioCalibration::SExportCalibrationXml" />
        </service>

        <!-- ******************************* Connections ************************************** -->

        <connect channel="chessboardProxy">
            <signal>action_chessBoardSize/updatedChessboardSize</signal>
        </connect>

        <!-- START AND STOP SERVICES -->
        <start uid="mainView" />
        <start uid="cameraLauncher" /> <!-- Must be started after mainView -->
        <start uid="CalibrationXmlWriter" />

    </config>
</extension>
