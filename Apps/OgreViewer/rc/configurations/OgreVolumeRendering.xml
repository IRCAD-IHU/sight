
<extension implements="::fwServices::registry::AppConfig">
    <id>OgreVolumeRendering</id>
    <parameters>
        <param name="GENERIC_UID" />
        <param name="WID_PARENT" />
        <param name="imageUID" />
        <param name="TFSelections" />
    </parameters>
    <config>

        <object type="::fwData::Composite">

            <service uid="${GENERIC_UID}_OgreVolumeRendering" type="::gui::view::IView" impl="::gui::view::SDefaultView" autoConnect="no">
                <gui>
                    <layout type="::fwGui::LineLayoutManager">
                        <orientation value="vertical" />
                        <view proportion="1" />
                        <view proportion="0" />
                    </layout>
                </gui>
                <registry>
                    <parent wid="${WID_PARENT}" />
                    <view sid="${GENERIC_UID}_volumeRenderingScene" start="yes" />
                    <view sid="${GENERIC_UID}_volumeRenderingInteractor" start="yes" />
                </registry>
            </service>

            <service uid="${GENERIC_UID}_volumeRenderingScene" impl="::fwRenderOgre::SRender" type="::fwRender::IRender" autoConnect="yes">
                <scene overlay="true" fullscreen="no">

                    <!-- Fix afterglow bug when dezooming -->
                    <background topColor="#DDDDDD" bottomColor="#43958D" topScale="0.7" bottomScale="1.0" />

                    <!-- Default Layer -->
                    <renderer id="default" layer="1" compositors="Default" />

                    <adaptor id="interactorAdaptor" class="::visuOgreAdaptor::SInteractorStyle" objectId="self">
                        <config renderer="default" style="VR" />
                    </adaptor>

                    <adaptor id="volumeRender" class="::visuOgreAdaptor::SVolumeRender" objectId="image" uid="${GENERIC_UID}_VR">
                        <config renderer="default" widgets="no" preintegration="no" mode="raytracing" selectedTFKey="SelectedTF" tfSelectionFwID="${TFSelections}"
                         volumeIllumination= "yes" satWidth="256" satHeight="256" satDepth="64" />
                    </adaptor>

                    <connect>
                        <signal>${GENERIC_UID}_samplingSlider/valueChanged</signal>
                        <slot>${GENERIC_UID}_VR/updateSampling</slot>
                    </connect>

                    <connect>
                        <signal>focalLengthSlider/valueChanged</signal>
                        <slot>${GENERIC_UID}_VR/setFocalDistance</slot>
                    </connect>

                    <connect>
                        <signal>${GENERIC_UID}_preIntBtn/toggled</signal>
                        <slot>${GENERIC_UID}_VR/togglePreintegration</slot>
                    </connect>

                    <connect>
                        <signal>${GENERIC_UID}_volumeIlluminationBtn/toggled</signal>
                        <slot>${GENERIC_UID}_VR/toggleVolumeIllumination</slot>
                    </connect>

                    <connect>
                        <signal>${GENERIC_UID}_toggleVrWidgetsBtn/toggled</signal>
                        <slot>${GENERIC_UID}_VR/toggleWidgets</slot>
                    </connect>

                </scene>
            </service>

            <service uid="${GENERIC_UID}_volumeRenderingInteractor" type="::gui::view::IView" impl="::gui::view::SDefaultView" autoConnect="no">
                <gui>
                    <layout type="::fwGui::LineLayoutManager">
                        <orientation value="vertical" />
                        <view proportion="0" />
                        <view proportion="0" />
                        <view proportion="1" />
                    </layout>
                </gui>
                <registry>
                    <view sid="${GENERIC_UID}_volumeRenderingSamplingInteractor" start="yes" />
                    <view sid="focalLengthSlider" start="yes" />
                    <view sid="${GENERIC_UID}_windowLevelVR" start="yes" />
                </registry>
            </service>

            <service uid="${GENERIC_UID}_volumeRenderingSamplingInteractor" type="::gui::view::IView" impl="::gui::view::SDefaultView" autoConnect="no">
                <gui>
                    <layout type="::fwGui::LineLayoutManager">
                        <orientation value="horizontal" />
                        <view proportion="1" />
                        <view proportion="0" />
                        <view proportion="0" />
                        <view proportion="0" />
                    </layout>
                </gui>
                <registry>
                    <view sid="${GENERIC_UID}_samplingSlider" start="yes" />
                    <view sid="${GENERIC_UID}_preIntBtn" start="yes" />
                    <view sid="${GENERIC_UID}_volumeIlluminationBtn" start="yes" />
                    <view sid="${GENERIC_UID}_toggleVrWidgetsBtn" start="yes" />
                </registry>
            </service>

            <!-- Negato source image -->
            <item key="image">
                <object uid="${imageUID}"  type="::fwData::Image" src="ref">

                    <!-- Negato windowing service -->
                    <service uid="${GENERIC_UID}_windowLevelVR" type="::gui::editor::IEditor" impl="::uiImage::WindowLevel" autoConnect="no">
                        <config selectedTFKey="SelectedTF" tfSelectionFwID="${TFSelections}" />
                    </service>

                </object>
            </item>

            <item key="sampling">
                <object uid="${GENERIC_UID}_samplingSliderValue" type="::fwData::Integer">
                    <service uid="${GENERIC_UID}_samplingSlider" impl="::guiQt::editor::SSlider" autoConnect="yes">
                        <defaultValue>512</defaultValue>
                        <value>512</value>
                        <text>Samples</text>
                        <range>
                            <min>128</min>
                            <max>4096</max>
                        </range>
                    </service>
                </object>
            </item>

            <item key="focalLength">
                <object uid="focalLengthIntVal" type="::fwData::Integer">
                    <!-- The value normally goes from 0. to 1. but we have to use an integer slider since float type is not supported yet -->
                    <service uid="focalLengthSlider" impl="::guiQt::editor::SSlider" autoConnect="no">
                        <defaultValue>50</defaultValue>
                        <value>0</value>
                        <text>Focal length</text>
                        <stepSize>1</stepSize>
                        <range>
                            <min>0</min>
                            <max>100</max>
                        </range>
                    </service>
                </object>
            </item>

            <item key="preIntegration" >
                <object uid="${GENERIC_UID}_preIntValue" type="::fwData::Boolean">
                    <service uid="${GENERIC_UID}_preIntBtn" type="::gui::editor::IEditor" impl="::guiQt::editor::SSignalButton" autoConnect="no">
                        <config>
                           <checkable>true</checkable>
                           <text>Pre-integration</text>
                           <checked>false</checked>
                        </config>
                    </service>
                </object>
            </item>

            <item key="volumeIllumination" >
                <object uid="${GENERIC_UID}_volumeIlluminationValue" type="::fwData::Boolean">
                    <service uid="${GENERIC_UID}_volumeIlluminationBtn" type="::gui::editor::IEditor" impl="::guiQt::editor::SSignalButton" autoConnect="no">
                        <config>
                           <checkable>true</checkable>
                           <text>Volume illumination</text>
                           <checked>false</checked>
                        </config>
                    </service>
                </object>
            </item>

            <item key="vrWidgets" >
                <object uid="${GENERIC_UID}_vrWidgetsValue" type="::fwData::Boolean">
                    <service uid="${GENERIC_UID}_toggleVrWidgetsBtn" type="::gui::editor::IEditor" impl="::guiQt::editor::SSignalButton" autoConnect="no">
                        <config>
                           <checkable>true</checkable>
                           <text>Widgets</text>
                           <checked>false</checked>
                        </config>
                    </service>
                </object>
            </item>

            <item key="TFSelectionsKey">
                <object uid="${TFSelections}" type="::fwData::Composite" src="ref" />
            </item>

            <start uid="${GENERIC_UID}_OgreVolumeRendering" />

        </object>

    </config>
</extension>
