<extension implements="::fwServices::registry::AppConfig">
    <id>OgreGenericScene</id>
    <parameters>
        <param name="WID_PARENT" />
        <param name="modelSeriesUID" />
        <param name="genericSceneUID" />
        <!-- 3D negato image -->
        <param name="imageUID" />
        <param name="TF" />
    </parameters>
    <config>
        <!-- ******************************* Objects declaration ****************************** -->

        <object uid="${modelSeriesUID}" type="::fwMedData::ModelSeries" src="ref" />
        <object uid="${imageUID}" type="::fwData::Image" src="ref" />

        <object uid="frameTL" type="::arData::FrameTL" />
        <object uid="videoImage" type="::fwData::Image" />
        <object uid="camera" type="::arData::Camera" />
        <object uid="pointList" type="::fwData::PointList" />

        <object uid="${TF}" type="::fwData::TransferFunction" src="deferred" />

        <!-- ******************************* UI declaration *********************************** -->
        <service uid="OgreSceneView" type="::gui::view::SDefaultView">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" />
                    <view proportion="0" />
                </layout>
                <toolBar/>
            </gui>
            <registry>
                <parent wid="${WID_PARENT}" />
                <toolBar sid="toolBar" start="yes" />
                <view sid="${genericSceneUID}" start="yes" />
                <view sid="negato3DInteractor" start="yes" />
            </registry>
        </service>

        <service uid="toolBar" type="::gui::aspect::SDefaultToolBar">
            <gui>
                <layout>
                    <menuItem name="Show/Hide negato interactor" icon="OgreViewer-0.1/icons/hide-view_horizontal.png" style="check" />
                    <separator/>
                    <editor/>
                    <menuItem name="Play" icon="arMedia-0.1/icons/start-cam.svg" />
                    <menuItem name="Pause" icon="arMedia-0.1/icons/pause-cam.svg" />
                    <menuItem name="Stop" icon="arMedia-0.1/icons/stop-cam.svg" />
                </layout>
            </gui>
            <registry>
                <menuItem sid="actionNegato3DInteractor" start="yes" />
                <editor sid="videoSelector" start="yes" />
                <menuItem sid="action_startVideo" start="yes" />
                <menuItem sid="action_pauseVideo" start="yes" />
                <menuItem sid="action_stopVideo" start="yes" />
            </registry>
        </service>

        <service uid="negato3DInteractor" type="::gui::view::SDefaultView">
            <gui>
                <layout type="::fwGui::LineLayoutManager">
                    <orientation value="vertical" />
                    <view proportion="1" />
                    <view proportion="1" />
                    <view proportion="1" />
                </layout>
            </gui>
            <registry>
                <view sid="sliderIndexEditor3D" start="yes" />
            </registry>
        </service>

        <!-- ************************************* Actions ************************************ -->
        <service uid="actionNegato3DInteractor" type="::gui::action::SModifyLayout">
            <config>
                <show_or_hide sid="negato3DInteractor" />
            </config>
        </service>

        <service uid="action_startVideo" type="::gui::action::SSlotCaller">
            <slots>
                <slot>frameGrabber/startCamera</slot>
            </slots>
        </service>

        <service uid="action_pauseVideo" type="::gui::action::SSlotCaller">
            <slots>
                <slot>frameGrabber/pauseCamera</slot>
            </slots>
        </service>

        <service uid="action_stopVideo" type="::gui::action::SSlotCaller">
            <slots>
                <slot>frameGrabber/stopCamera</slot>
            </slots>
        </service>

        <!-- ******************************* Begin Generic Scene ******************************* -->
        <service uid="${genericSceneUID}" type="::fwRenderOgre::SRender">
            <scene overlay="true">
                <background topColor="#DDDDDD" bottomColor="#43958D" topScale="0.7" bottomScale="1.0" />
                <layer id="video" depth="1" />
                <layer id="default" depth="2" transparency="HybridTransparency" numPeels="3"/>
                <adaptor uid="videoAdapter" />
                <adaptor uid="interactorAdaptorVideo" />
                <adaptor uid="interactorAdaptor" />
                <adaptor uid="selectInteractorAdaptor" />
                <adaptor uid="modelSeriesAdaptor" />
                <adaptor uid="negato3DAdaptor" />
                <adaptor uid="pointListAdaptor" />
            </scene>
        </service>

        <service uid="videoAdapter" type="::visuOgreAdaptor::SVideo">
            <in key="image" uid="videoImage" autoConnect="yes" />
            <in key="camera" uid="camera" autoConnect="yes" />
            <config layer="video" />
        </service>

        <service uid="interactorAdaptorVideo" type="::visuOgreAdaptor::SInteractorStyle">
            <in key="object" uid="camera" />
            <config layer="video" style="Fixed" />
        </service>

        <service uid="interactorAdaptor" type="::visuOgreAdaptor::SInteractorStyle">
            <config layer="default" style="Trackball" />
        </service>

        <service uid="selectInteractorAdaptor" type="::visuOgreAdaptor::SInteractorStyle">
            <config layer="default" style="Mesh" />
        </service>

        <service uid="modelSeriesAdaptor" type="::visuOgreAdaptor::SModelSeries" autoConnect="yes">
            <in key="model" uid="${modelSeriesUID}" />
            <config layer="default" />
        </service>

        <service uid="negato3DAdaptor" type="::visuOgreAdaptor::SNegato3D">
            <inout key="image" uid="${imageUID}" autoConnect="yes" />
            <inout key="tf" uid="${TF}" optional="yes" />
            <config layer="default" />
        </service>

        <service uid="pointListAdaptor" type="::visuOgreAdaptor::SPointList" autoConnect="yes">
            <in key="pointList" uid="pointList" />
            <config layer="default" autoresetcamera="no" color="#ff0000"/>
        </service>

        <!-- ********************************* End Generic Scene ******************************* -->

        <!-- ************************************* Services ************************************ -->
        <service uid="synchronizer" type="::videoTools::SFrameMatrixSynchronizer" worker="videoWorker">
            <in group="frameTL">
                <key uid="frameTL" />
            </in>
            <inout group="image">
                <key uid="videoImage" />
            </inout>
            <framerate>30</framerate>
        </service>

        <service uid="sliderIndexEditor3D" type="::uiImageQt::SliceIndexPositionEditor" autoConnect="yes">
            <inout key="image" uid="${imageUID}" />
            <sliceIndex>Sagittal</sliceIndex>
        </service>

        <service uid="frameGrabber" type="::videoQt::SFrameGrabber">
            <in key="camera" uid="camera" />
            <inout key="frameTL" uid="frameTL" />
        </service>

        <service uid="videoSelector" type="::videoQt::editor::SCamera">
            <inout key="camera" uid="camera" />
            <videoSupport>yes</videoSupport>
        </service>

        <service uid="addPointInList" type="::uiVisuOgre::SAddPoint">
            <inout key="pointList" uid="pointList" />
        </service>

        <connect>
            <signal>selectInteractorAdaptor/pointClickedSignal</signal>
            <slot>addPointInList/addPoint</slot>
        </connect>

        <!-- *************************************** Starts ************************************ -->
        <start uid="OgreSceneView" />
        <start uid="frameGrabber" />
        <start uid="synchronizer" />

        <!-- Ogre scene '${genericSceneUID}' -->
        <start uid="videoAdapter" />
        <start uid="interactorAdaptorVideo" />
        <start uid="interactorAdaptor" />
        <start uid="selectInteractorAdaptor" />
        <start uid="modelSeriesAdaptor" />
        <start uid="negato3DAdaptor" />
        <start uid="pointListAdaptor" />
        <start uid="addPointInList" />

        <update uid="actionNegato3DInteractor" />

    </config>
</extension>
