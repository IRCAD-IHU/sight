<?xml version="1.0" encoding="UTF-8"?>

<plugin id="OgreViewer" version="@PROJECT_VERSION@" >

    <requirement id="dataReg" />
    <requirement id="servicesReg" />
    <requirement id="visuOgreAdaptor" />
    <requirement id="visuOgreQt" />
    <requirement id="visuVTKQt" />
    <requirement id="material" />
    <requirement id="scene2D" />
    <requirement id="preferences" />

    <xi:include href="configurations/vtkGenericScene.xml" xmlns:xi="http://www.w3.org/2003/XInclude" />
    <xi:include href="configurations/OgreGenericScene.xml" xmlns:xi="http://www.w3.org/2003/XInclude" />
    <xi:include href="configurations/OgreNegato2D.xml" xmlns:xi="http://www.w3.org/2003/XInclude" />
    <xi:include href="configurations/OgreVolumeRendering.xml" xmlns:xi="http://www.w3.org/2003/XInclude" />
    <xi:include href="configurations/ManageOgreOrganWithSeries.xml" xmlns:xi="http://www.w3.org/2003/XInclude" />

    <extension implements="::fwServices::registry::ServiceConfig">
        <id>MDAtomsConfig</id>
        <desc>reader/writer config to read/write an atom representing a medical data</desc>
        <config>
            <patcher context="MedicalData" version="V09ALA" />
        </config>
    </extension>

    <extension implements="::fwServices::registry::AppConfig">
        <id>OgreViewer_Extension</id>
        <config>

            <!-- ******************************* Objects declaration ****************************** -->

            <object uid="modelSeriesUID" type="::fwMedData::ModelSeries" />
            <object uid="imageUID" type="::fwData::Image" />
            <object uid="maskUID" type="::fwData::Image" />

            <object uid="cameraTF_UID" type="::fwData::TransformationMatrix3D" />
            <object uid="TF" type="::fwData::TransferFunction" src="deferred" />

            <!-- ******************************* UI declaration *********************************** -->

            <service uid="ihm" type="::gui::frame::SDefaultFrame" >
                <gui>
                    <frame>
                        <name>Ogre Viewer</name>
                        <icon>OgreViewer-@PROJECT_VERSION@/ogre_head.svg</icon>
                        <minSize width="1100" height="700" />
                    </frame>
                    <menuBar />
                </gui>
                <registry>
                    <menuBar sid="menuBar" start="yes" />
                    <view sid="multiView_scene1" start="yes" />
                </registry>
            </service>

            <service uid="menuBar" type="::gui::aspect::SDefaultMenuBar" >
                <gui>
                    <layout>
                        <menu name="File" />
                    </layout>
                </gui>
                <registry>
                    <menu sid="menu_File" start="yes" />
                </registry>
            </service>

            <service uid="multiView_scene1" type="::gui::view::SDefaultView" >
                <gui>
                    <layout type="::fwGui::CardinalLayoutManager">
                        <view align="center" />
                        <view align="right" minWidth="500" />
                    </layout>
                </gui>
                <registry>
                    <view sid="tabView" start="yes" />
                    <view sid="rightView" start="yes" />
                </registry>
            </service>

            <service uid="tabView" type="::gui::view::SDefaultView" >
                <gui>
                    <layout type="::fwGui::TabLayoutManager">
                        <view caption="VTK" selected="no" />
                        <view caption="Ogre" selected="no" />
                        <view caption="2D Negato Ogre" selected="no" />
                        <view caption="Ogre VR" selected="yes" />
                    </layout>
                </gui>
                <registry>
                    <view wid="VTKSceneView" start="yes" />
                    <view wid="OgreSceneView" start="yes" />
                    <view wid="OgreNegato2DView" start="yes" />
                    <view wid="OgreVolumeRenderingView" start="yes" />
                </registry>
            </service>

            <service uid="rightView" type="::gui::view::SDefaultView" >
                <gui>
                    <layout type="::fwGui::TabLayoutManager">
                        <view caption="Compositor" />
                        <view caption="Organ manager" selected="yes" />
                        <view caption="Light manager" />
                        <view caption="Negato histogram" />
                        <view caption="IDVR" />
                    </layout>
                </gui>
                <registry>
                    <view sid="compositorView" start="yes" />
                    <view wid="organView" start="yes" />
                    <view wid="lightView" start="yes" />
                    <view wid="histogramView" start="yes" />
                    <view wid="idvrView" start="yes" />
                </registry>
            </service>

            <service uid="compositorView" type="::gui::view::SDefaultView" >
                <gui>
                    <layout type="::fwGui::ToolboxLayoutManager">
                        <orientation value="vertical" />
                        <view caption="Compositor selector" expanded="true" />
                        <view caption="Compositor parameters" expanded="true" />
                        <view caption="Transparency settings" expanded="true" />
                    </layout>
                </gui>
                <registry>
                    <view sid="compositorSelector" />
                    <view sid="compositorParameters" />
                    <view sid="propertiesView" start="yes"/>
                </registry>
            </service>

            <service uid="propertiesView" type="::gui::view::SDefaultView" >
                <gui>
                    <layout type="::fwGui::LineLayoutManager">
                        <orientation value="vertical" />
                        <view/>
                    </layout>
                </gui>
                <registry>
                    <view sid="CoreEditor" />
                </registry>
            </service>

            <service uid="menu_File" type="::gui::aspect::SDefaultMenu" >
                <gui>
                    <layout>
                        <menuItem name="Open model series..." shortcut="Ctrl+M" />
                        <menuItem name="Open image..." shortcut="Ctrl+O" />
                        <menuItem name="Save model series..." shortcut="Ctrl+S" />
                        <separator />
                        <menuItem name="Quit" specialAction="QUIT" shortcut="Ctrl+Q" />
                    </layout>
                </gui>
                <registry>
                    <menuItem sid="action_openMesh" start="yes" />
                    <menuItem sid="action_openNegato" start="yes" />
                    <menuItem sid="action_saveFile" start="yes" />
                    <menuItem sid="action_quit" start="yes" />
                </registry>
            </service>

            <!-- ******************************* Actions ****************************************** -->

            <service uid="action_openMesh" type="::gui::action::SStarter" >
                <start uid="readerPathMeshFile" />
            </service>

            <service uid="action_openNegato" type="::gui::action::SStarter" >
                <start uid="imageReader" />
            </service>

            <service uid="action_saveFile" type="::gui::action::SStarter" >
                <start uid="writerPathMeshFile" />
            </service>

            <service uid="action_quit" type="::gui::action::SQuit"  />

            <!-- ************************ Configuration launchers ********************************* -->

            <service uid="cfgVTKGenericScene" type="::fwServices::SConfigController" >
                <appConfig id="VTKGenericScene" />
                <inout key="modelSeriesUID" uid="modelSeriesUID" />
                <parameter replace="WID_PARENT" uid="VTKSceneView" />
            </service>

            <service uid="cfgOgreGenericScene" type="::fwServices::SConfigController" >
                <appConfig id="OgreGenericScene" />
                <inout key="modelSeriesUID" uid="modelSeriesUID" />
                <inout key="cameraTF" uid="cameraTF_UID" />
                <inout key="imageUID" uid="imageUID" />
                <parameter replace="WID_PARENT" uid="OgreSceneView" />
                <parameter replace="genericSceneUID" uid="genericSceneUID" />
                <!-- The object 'TF' is deferred and is created in 'OgreHistogramManager', its id is given between
                     configuration to receive the signal emitted when the object is created. -->
                <parameter replace="TF" by="TF" />
            </service>

            <service uid="cfgOgreNegato2D" type="::fwServices::SConfigController" >
                <appConfig id="OgreNegato2D" />
                <inout key="imageUID" uid="imageUID" />
                <parameter replace="WID_PARENT" uid="OgreNegato2DView" />
                <!-- The object 'TF' is deferred and is created in 'OgreHistogramManager', its id is given between
                     configuration to receive the signal emitted when the object is created. -->
                <parameter replace="TF" by="TF" />
            </service>

            <service uid="cfgOgreVolumeRendering" type="::fwServices::SConfigController" >
                <appConfig id="OgreVolumeRendering" />
                <inout key="imageUID" uid="imageUID" />
                <inout key="maskUID" uid="maskUID" />
                <parameter replace="WID_PARENT" uid="OgreVolumeRenderingView" />
                <parameter replace="idvrEnumParamChannel" by="idvrEnumParamChannel" />
                <parameter replace="idvrBoolParamChannel" by="idvrBoolParamChannel" />
                <parameter replace="idvrDoubleParamChannel" by="idvrDoubleParamChannel" />
                <parameter replace="idvrColorParamChannel" by="idvrColorParamChannel" />
                <!-- The object 'TF' is deferred and is created in 'OgreHistogramManager', its id is given between
                     configuration to receive the signal emitted when the object is created. -->
                <parameter replace="TF" by="TF" />
            </service>

            <service uid="cfgOrganManagerConfig"  type="::fwServices::SConfigController">
                <appConfig id="OgreOrganManagerWithSeries" />
                <inout key="ORGAN_MANAGER_MODELSERIES" uid="modelSeriesUID" />
                <parameter replace="WID_PARENT" uid="organView" />
                <parameter replace="ICON_PATH" by="arMedia-0.1/icons/app.ico" />
            </service>

            <service uid="cfgLightManager"  type="::fwServices::SConfigController">
                <appConfig id="OgreLightManager" />
                <parameter replace="WID_PARENT" uid="lightView" />
                <parameter replace="ICON_PATH" by="arMedia-0.1/icons/app.ico" />
            </service>

            <service uid="cfgHistogramManager" type="::fwServices::SConfigController">
                <appConfig id="OgreHistogramManager" />
                <inout key="imageUID" uid="imageUID" />
                <inout key="maskUID" uid="maskUID" />
                <parameter replace="WID_PARENT" uid="histogramView" />
                <parameter replace="ICON_PATH" by="arMedia-0.1/icons/app.ico" />
                <!-- The object 'TF' is deferred and is created in 'OgreHistogramManager', its id is given between
                     configuration to receive the signal emitted when the object is created. -->
                <parameter replace="TF" by="TF" />
            </service>

            <service uid="cfgIDVRManager"  type="::fwServices::SConfigController">
                <appConfig id="OgreIDVR" />
                <inout key="maskUID" uid="maskUID" />
                <parameter replace="WID_PARENT" uid="idvrView" />
                <parameter replace="ICON_PATH" by="arMedia-0.1/icons/app.ico" />
                <parameter replace="idvrEnumParamChannel" by="idvrEnumParamChannel" />
                <parameter replace="idvrBoolParamChannel" by="idvrBoolParamChannel" />
                <parameter replace="idvrDoubleParamChannel" by="idvrDoubleParamChannel" />
                <parameter replace="idvrColorParamChannel" by="idvrColorParamChannel" />
            </service>

            <!-- ******************************* Services ***************************************** -->

            <service uid="compositorSelector" type="::uiVisuOgre::SCompositorSelector"  />

            <service uid="compositorParameters" type="::uiVisuOgre::SCompositorParameterEditor"  >
                <render uid="genericSceneUID" />
                <layer id="default" />
            </service>

            <service uid="CoreEditor" type="::uiVisuOgre::SCoreCompositorEditor"  />

            <service uid="readerPathMeshFile" type="::uiIO::editor::SIOSelector" >
                <in key="target" uid="modelSeriesUID" />
                <type mode="reader" />
            </service>

            <service uid="writerPathMeshFile" type="::uiIO::editor::SIOSelector" >
                <in key="target" uid="modelSeriesUID" />
                <type mode="writer" />
            </service>

            <service uid="imageReader" type="::uiIO::editor::SIOSelector" >
                <in key="target" uid="imageUID" />
                <type mode="reader" />
            </service>

            <service uid="medicalImage" type="::ctrlSelection::MedicalImageSrv" >
                <inout key="image" uid="imageUID" autoConnect="yes" />
            </service>

            <!-- Start/Stop services -->
            <start uid="medicalImage" />
            <start uid="ihm" />
            <start uid="cfgVTKGenericScene" />
            <start uid="cfgOgreGenericScene" />
            <start uid="cfgOgreNegato2D" />
            <start uid="cfgOgreVolumeRendering" />
            <start uid="cfgOrganManagerConfig" />
            <start uid="cfgLightManager" />
            <start uid="cfgHistogramManager" />
            <start uid="cfgIDVRManager" />
            <start uid="compositorSelector" />
            <start uid="compositorParameters" />
            <start uid="CoreEditor" />

        </config>

    </extension>
</plugin>
